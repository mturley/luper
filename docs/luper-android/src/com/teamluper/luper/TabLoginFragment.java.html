<!DOCTYPE html><html><head><title>TabLoginFragment.java</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../../../luper-android/src/com/androidlearner/widget/DragThingPlayhead.java.html" class="source "><span class="base_path">luper-android / src / com / androidlearner / widget / </span><span class="file_name">DragThingPlayhead.java</span></a><a href="../../../../../luper-android/src/com/androidlearner/widget/DragThing.java.html" class="source "><span class="base_path">luper-android / src / com / androidlearner / widget / </span><span class="file_name">DragThing.java</span></a><a href="../../../../../luper-android/src/com/androidlearner/widget/ClipThing.java.html" class="source "><span class="base_path">luper-android / src / com / androidlearner / widget / </span><span class="file_name">ClipThing.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/PopupTestActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">PopupTestActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperProjectEditorActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperProjectEditorActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/Sequence.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">Sequence.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabProjectsFragment.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabProjectsFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/Clip.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">Clip.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/Track.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">Track.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/CanvasTestActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">CanvasTestActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/AudioRecorderTestActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">AudioRecorderTestActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperForgotPasswordActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperForgotPasswordActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/DragThing.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">DragThing.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabLoginFragment.java.html" class="source selected"><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabLoginFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/DialogFactory.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">DialogFactory.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/SQLiteHelper.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">SQLiteHelper.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/User.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">User.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/FileSelectorActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">FileSelectorActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperMainActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperMainActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/Playhead.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">Playhead.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/Lambda.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">Lambda.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LoopTestActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LoopTestActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabFriendsFragment.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabFriendsFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/ColorChipButton.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">ColorChipButton.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperLoginActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperLoginActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TrackView.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TrackView.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabSplashFragment.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabSplashFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperDevToolsActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperDevToolsActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/DragTest.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">DragTest.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperHelp.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperHelp.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabHomeFragment.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabHomeFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/AudioFile.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">AudioFile.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabsAdapter.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabsAdapter.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/LuperSettingsActivity.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">LuperSettingsActivity.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/TabRegisterFragment.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">TabRegisterFragment.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/rest/LuperRestClient.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / rest / </span><span class="file_name">LuperRestClient.java</span></a><a href="../../../../../luper-android/src/com/teamluper/luper/SQLiteDataSource.java.html" class="source "><span class="base_path">luper-android / src / com / teamluper / luper / </span><span class="file_name">SQLiteDataSource.java</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>TabLoginFragment.java</h1><div class="filepath">luper-android/src/com/teamluper/luper/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">teamluper</span><span class="o">.</span><span class="na">luper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.animation.Animator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.animation.AnimatorListenerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.annotation.TargetApi</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.AsyncTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Build</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.v4.app.Fragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.KeyEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.inputmethod.EditorInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.EditText</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.RelativeLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.facebook.Request</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.Response</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.Session</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.SessionLoginBehavior</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.SessionState</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.UiLifecycleHelper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.model.GraphUser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.widget.LoginButton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.googlecode.androidannotations.annotations.Background</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.googlecode.androidannotations.annotations.EFragment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.googlecode.androidannotations.annotations.UiThread</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.googlecode.androidannotations.annotations.rest.RestService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.teamluper.luper.rest.LuperRestClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="nd">@EFragment</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TabLoginFragment</span> <span class="kd">extends</span> <span class="n">Fragment</span> <span class="o">{</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Values for email and password at the time of the login attempt.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">private</span> <span class="n">String</span> <span class="n">mEmail</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">mPassword</span><span class="o">;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>UI references.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">private</span> <span class="n">EditText</span> <span class="n">mEmailView</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">EditText</span> <span class="n">mPasswordView</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">View</span> <span class="n">mLoginFormView</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">View</span> <span class="n">mLoginStatusView</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">TextView</span> <span class="n">mLoginStatusMessageView</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">SQLiteDataSource</span> <span class="n">dataSource</span><span class="o">;</span>

  <span class="nd">@RestService</span>
  <span class="n">LuperRestClient</span> <span class="n">rest</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HASH_COUNT</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="o">((</span><span class="n">LuperLoginActivity</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">()).</span><span class="na">loginFragment</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="n">uiHelper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UiLifecycleHelper</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">callback</span><span class="o">);</span>
    <span class="n">uiHelper</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Gets called when login activity gets called and session
is not null</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="na">getActiveSession</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">session</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
             <span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">isOpened</span><span class="o">()</span> <span class="o">||</span> <span class="n">session</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">)</span> <span class="o">{</span>
          <span class="n">onSessionStateChange</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">session</span><span class="o">.</span><span class="na">getState</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">uiHelper</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
      <span class="n">showProgress</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
      <span class="n">uiHelper</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onPause</span><span class="o">();</span>
      <span class="n">uiHelper</span><span class="o">.</span><span class="na">onPause</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
      <span class="n">uiHelper</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
      <span class="n">uiHelper</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="n">LayoutInflater</span> <span class="n">infl</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">vg</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">vg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">infl</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">tab_login_layout</span><span class="o">,</span> <span class="n">vg</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="n">Activity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>set up the SQLite database access.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">dataSource</span> <span class="o">=</span> <span class="o">((</span><span class="n">LuperLoginActivity</span><span class="o">)</span><span class="n">a</span><span class="o">).</span><span class="na">getDataSource</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">dataSource</span><span class="o">.</span><span class="na">isOpen</span><span class="o">())</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">open</span><span class="o">();</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Set up the login form.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">mEmail</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getIntent</span><span class="o">().</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&quot;luperPrefilledEmail&quot;</span><span class="o">);</span>
    <span class="n">mEmailView</span> <span class="o">=</span> <span class="o">(</span><span class="n">EditText</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_email</span><span class="o">);</span>
    <span class="n">mEmailView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">mEmail</span><span class="o">);</span>

    <span class="n">mPasswordView</span> <span class="o">=</span> <span class="o">(</span><span class="n">EditText</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_password</span><span class="o">);</span>
    <span class="n">mPasswordView</span>
      <span class="o">.</span><span class="na">setOnEditorActionListener</span><span class="o">(</span><span class="k">new</span> <span class="n">TextView</span><span class="o">.</span><span class="na">OnEditorActionListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onEditorAction</span><span class="o">(</span><span class="n">TextView</span> <span class="n">textView</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span>
                                      <span class="n">KeyEvent</span> <span class="n">keyEvent</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">EditorInfo</span><span class="o">.</span><span class="na">IME_NULL</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">attemptLogin</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">});</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Give facebook loginbutton email permissions</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">LoginButton</span> <span class="n">authButton</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoginButton</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">authButton</span><span class="o">);</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>TODO - help luper use facebook app without failing. until then
This line should prevent Luper from launching the facebook app for login,
and use the web splash instead. </p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">authButton</span><span class="o">.</span><span class="na">setLoginBehavior</span><span class="o">(</span><span class="n">SessionLoginBehavior</span><span class="o">.</span><span class="na">SUPPRESS_SSO</span><span class="o">);</span>
    <span class="n">authButton</span><span class="o">.</span><span class="na">setFragment</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">authButton</span><span class="o">.</span><span class="na">setReadPermissions</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">));</span>

    <span class="n">mLoginFormView</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_form</span><span class="o">);</span>
    <span class="n">mLoginStatusView</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_status</span><span class="o">);</span>
    <span class="n">mLoginStatusMessageView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_status_message</span><span class="o">);</span>

    <span class="n">showProgress</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">login_button</span><span class="o">).</span><span class="na">setOnClickListener</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">attemptLogin</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>

    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
  <span class="o">}</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Updates the Luper interface once usr is logged into Facebook.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&quot;LoginFragment&quot;</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">Session</span><span class="o">.</span><span class="na">StatusCallback</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Session</span><span class="o">.</span><span class="na">StatusCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">Session</span> <span class="n">sesh</span><span class="o">,</span> <span class="n">SessionState</span> <span class="n">seshState</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">onSessionStateChange</span><span class="o">(</span><span class="n">sesh</span><span class="o">,</span><span class="n">seshState</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">};</span>

  <span class="kd">private</span> <span class="n">UiLifecycleHelper</span> <span class="n">uiHelper</span><span class="o">;</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSessionStateChange</span><span class="o">(</span><span class="n">Session</span> <span class="n">sesh</span><span class="o">,</span> <span class="n">SessionState</span> <span class="n">seshState</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">LuperLoginActivity_</span> <span class="n">a</span> <span class="o">=</span> <span class="o">(</span><span class="n">LuperLoginActivity_</span><span class="o">)</span><span class="n">getActivity</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">seshState</span><span class="o">.</span><span class="na">isOpened</span><span class="o">())</span> <span class="o">{</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p><div class="dox"><div class="summary"><p>usr logged in *</p></div><div class="body"></div></div>Create new request to facebook API</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">Request</span><span class="o">.</span><span class="na">executeMeRequestAsync</span><span class="o">(</span><span class="n">sesh</span><span class="o">,</span> <span class="k">new</span> <span class="n">Request</span><span class="o">.</span><span class="na">GraphUserCallback</span><span class="o">()</span> <span class="o">{</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>callback after Graph API response with user object</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">(</span><span class="n">GraphUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>loadActiveSession(user);
                  TextView welcome = (TextView) findViewById(R.id.welcome);
                  welcome.setText("Hello " + user.getName() + "!");</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Let's snag the user's email address to create a unique ID for Mike's DB
updates the header on the login tab</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>If email doesn't work, let's use the GraphUser's facebook link as unique ID
naturally each link is associated with at most one user</p>
</td><td class="code"><div class="highlight"><pre>              <span class="n">TextView</span> <span class="n">header_login</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">header_login</span><span class="o">);</span>
              <span class="n">header_login</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                  <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                  <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                  <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getLink</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                  <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getFirstName</span><span class="o">()+</span> <span class="n">user</span><span class="o">.</span><span class="na">asMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">));</span>
            <span class="o">}</span>
          <span class="n">a</span><span class="o">.</span><span class="na">completeFacebookLogin</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">asMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>this shouldn't need to be called. but for some reason LuperLogin isn't switching
over to Main automatically.
a.startMainActivity();</p>
</td><td class="code"><div class="highlight"><pre>        <span class="o">}</span>

      <span class="o">});</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">seshState</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>usr logged out</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">TextView</span> <span class="n">header_login</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">header_login</span><span class="o">);</span>
      <span class="n">header_login</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Come back soon!&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>probably shouldn't be here</p>
</td><td class="code"><div class="highlight"><pre>    <span class="o">}</span>
  <span class="o">}</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>@Override
 public void onResume() {
   super.onResume();
   showProgress(false);
 }</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Attempts to sign in or register the account specified by the login form. If<br />there are form errors (invalid email, missing fields, etc.), the errors are<br />presented and no actual login attempt is made.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">attemptLogin</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Activity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">LuperMainActivity</span><span class="o">.</span><span class="na">deviceIsOnline</span><span class="o">(</span><span class="n">a</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">DialogFactory</span><span class="o">.</span><span class="na">alert</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">&quot;Login Failed!&quot;</span><span class="o">,</span> <span class="s">&quot;You are not connected to the internet! &quot;</span> <span class="o">+</span>
        <span class="s">&quot;You must be online to log in.  Once logged in, however, you can use LÃ¼per while offline.&quot;</span><span class="o">);</span>
    <span class="o">}</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Reset errors.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">mEmailView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">mPasswordView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Store values at the time of the login attempt.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">mEmail</span> <span class="o">=</span> <span class="n">mEmailView</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">mPassword</span> <span class="o">=</span> <span class="n">mPasswordView</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="n">cancel</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">View</span> <span class="n">focusView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Check for a valid password.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">mPassword</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">mPasswordView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_field_required</span><span class="o">));</span>
      <span class="n">focusView</span> <span class="o">=</span> <span class="n">mPasswordView</span><span class="o">;</span>
      <span class="n">cancel</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mPassword</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mPasswordView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_invalid_password</span><span class="o">));</span>
      <span class="n">focusView</span> <span class="o">=</span> <span class="n">mPasswordView</span><span class="o">;</span>
      <span class="n">cancel</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Check for a valid email address.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">mEmail</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">mEmailView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_field_required</span><span class="o">));</span>
      <span class="n">focusView</span> <span class="o">=</span> <span class="n">mEmailView</span><span class="o">;</span>
      <span class="n">cancel</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">mEmail</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;@&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">mEmailView</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_invalid_email</span><span class="o">));</span>
      <span class="n">focusView</span> <span class="o">=</span> <span class="n">mEmailView</span><span class="o">;</span>
      <span class="n">cancel</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">cancel</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>There was an error; don't attempt login and focus the first
form field with an error.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">focusView</span><span class="o">.</span><span class="na">requestFocus</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Show a progress spinner, and kick off a background task to
perform the user login attempt.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">mLoginStatusMessageView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">progress_logging_in</span><span class="o">);</span>
      <span class="n">showProgress</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">completeLoginAttempt</span><span class="o">(</span><span class="n">mEmail</span><span class="o">,</span> <span class="n">mPassword</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Background</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completeLoginAttempt</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>first, fetch a challenge salt to hash the password with.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">try</span> <span class="o">{</span>
      <span class="n">JSONObject</span> <span class="n">challengeRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
      <span class="n">challengeRequest</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">challengeResponseJSON</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">getLoginChallengeSalt</span><span class="o">(</span><span class="n">challengeRequest</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="n">JSONObject</span> <span class="n">challengeResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">challengeResponseJSON</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">isResponseSuccessful</span><span class="o">(</span><span class="n">challengeResponse</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">loginFailure</span><span class="o">(</span><span class="n">challengeResponse</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">));</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>now we take the challenge salt and compute the login attempt hash.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">String</span> <span class="n">salt</span> <span class="o">=</span> <span class="n">challengeResponse</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;salt&quot;</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">attemptHash</span> <span class="o">=</span> <span class="n">saltyHashBrowns</span><span class="o">(</span><span class="n">sha256</span><span class="o">(</span><span class="n">password</span><span class="o">),</span> <span class="n">salt</span><span class="o">,</span> <span class="n">HASH_COUNT</span><span class="o">);</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>assemble the actual login attempt request</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">JSONObject</span> <span class="n">loginRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
      <span class="n">loginRequest</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
      <span class="n">loginRequest</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;attemptHash&quot;</span><span class="o">,</span> <span class="n">attemptHash</span><span class="o">);</span>
      <span class="n">String</span> <span class="n">loginResponseJSON</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">validateLoginAttempt</span><span class="o">(</span><span class="n">loginRequest</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="n">JSONObject</span> <span class="n">loginResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">loginResponseJSON</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">isResponseSuccessful</span><span class="o">(</span><span class="n">loginResponse</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">loginFailure</span><span class="o">(</span><span class="n">loginResponse</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">));</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">loginResponse</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;isLoginValid&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">loginFailure</span><span class="o">(</span><span class="s">&quot;The email address or password you entered was invalid!&quot;</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">User</span> <span class="n">existingUser</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getUserByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">existingUser</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>we need to create a user first, matching the user from the server</p>
</td><td class="code"><div class="highlight"><pre>        <span class="n">String</span> <span class="n">userFromServerJSON</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="na">fetchUserByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">JSONObject</span> <span class="n">userFromServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">userFromServerJSON</span><span class="o">);</span>

        <span class="n">existingUser</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">userFromServer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;_id&quot;</span><span class="o">),</span><span class="n">userFromServer</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">),</span><span class="n">email</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setActiveUser</span><span class="o">(</span><span class="n">existingUser</span><span class="o">);</span>
      <span class="n">loginSuccess</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">JSONException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;luper&quot;</span><span class="o">,</span><span class="s">&quot;=== JSON Exception while attempting to validate login === Exception: &quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">loginFailure</span><span class="o">(</span><span class="s">&quot;Something went wrong while logging in!&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loginSuccess</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">mEmailView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mEmailView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">mPasswordView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mPasswordView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">LuperMainActivity_</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@UiThread</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loginFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">showProgress</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">DialogFactory</span><span class="o">.</span><span class="na">alert</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="s">&quot;Login Failed!&quot;</span><span class="o">,</span> <span class="n">errorMessage</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isResponseSuccessful</span><span class="o">(</span><span class="n">JSONObject</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;success&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;luper&quot;</span><span class="o">,</span><span class="s">&quot;=== A REGISTRATION API RESPONSE WAS UNSUCCESSFUL === Exception: &quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="n">String</span> <span class="nf">sha256</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">MessageDigest</span> <span class="n">md</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;SHA-256&quot;</span><span class="o">);</span>
      <span class="n">md</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">password</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">&quot;UTF-8&quot;</span><span class="o">));</span> <span class="c1">// Change this to &quot;UTF-16&quot; if needed</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">digest</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="na">digest</span><span class="o">();</span>
      <span class="k">return</span> <span class="nf">bytesToHex</span><span class="o">(</span><span class="n">digest</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&quot;luper&quot;</span><span class="o">,</span> <span class="s">&quot;=== ERROR COMPUTING SHA256 LOGIN ATTEMPT PASSWORD HASH === Exception: &quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">bytesToHex</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">hexArray</span> <span class="o">=</span> <span class="o">{</span><span class="sc">&#39;0&#39;</span><span class="o">,</span><span class="sc">&#39;1&#39;</span><span class="o">,</span><span class="sc">&#39;2&#39;</span><span class="o">,</span><span class="sc">&#39;3&#39;</span><span class="o">,</span><span class="sc">&#39;4&#39;</span><span class="o">,</span><span class="sc">&#39;5&#39;</span><span class="o">,</span><span class="sc">&#39;6&#39;</span><span class="o">,</span><span class="sc">&#39;7&#39;</span><span class="o">,</span><span class="sc">&#39;8&#39;</span><span class="o">,</span><span class="sc">&#39;9&#39;</span><span class="o">,</span><span class="sc">&#39;a&#39;</span><span class="o">,</span><span class="sc">&#39;b&#39;</span><span class="o">,</span><span class="sc">&#39;c&#39;</span><span class="o">,</span><span class="sc">&#39;d&#39;</span><span class="o">,</span><span class="sc">&#39;e&#39;</span><span class="o">,</span><span class="sc">&#39;f&#39;</span><span class="o">};</span>
    <span class="kt">char</span><span class="o">[]</span> <span class="n">hexChars</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">*</span> <span class="mi">2</span><span class="o">];</span>
    <span class="kt">int</span> <span class="n">v</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="o">;</span>
      <span class="n">hexChars</span><span class="o">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">hexArray</span><span class="o">[</span><span class="n">v</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">];</span>
      <span class="n">hexChars</span><span class="o">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">hexArray</span><span class="o">[</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">hexChars</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">saltyHashBrowns</span><span class="o">(</span><span class="n">String</span> <span class="n">simpleHashedPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">salt</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hashCount</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Prefix the password with the salt</p>
</td><td class="code"><div class="highlight"><pre>    <span class="n">String</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">salt</span> <span class="o">+</span> <span class="n">simpleHashedPassword</span><span class="o">;</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Hashing our hashes times a hundred thousand, for security!</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hashCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="n">sha256</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span> <span class="c1">// hashity hash</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showProgressSpinner</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">show</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">showProgress</span><span class="o">(</span><span class="n">show</span><span class="o">);</span>
  <span class="o">}</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Shows the progress UI and hides the login form.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nd">@TargetApi</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB_MR2</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">showProgress</span><span class="o">(</span><span class="kd">final</span> <span class="kt">boolean</span> <span class="n">show</span><span class="o">)</span> <span class="o">{</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>On Honeycomb MR2 we have the ViewPropertyAnimator APIs, which allow
for very easy animations. If available, use these APIs to fade-in
the progress spinner.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">HONEYCOMB_MR2</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">shortAnimTime</span> <span class="o">=</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getInteger</span><span class="o">(</span>
        <span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">integer</span><span class="o">.</span><span class="na">config_shortAnimTime</span><span class="o">);</span>

      <span class="n">mLoginStatusView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
      <span class="n">mLoginStatusView</span><span class="o">.</span><span class="na">animate</span><span class="o">().</span><span class="na">setDuration</span><span class="o">(</span><span class="n">shortAnimTime</span><span class="o">).</span><span class="na">alpha</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setListener</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimatorListenerAdapter</span><span class="o">()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mLoginStatusView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>

      <span class="n">mLoginFormView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
      <span class="n">mLoginFormView</span><span class="o">.</span><span class="na">animate</span><span class="o">().</span><span class="na">setDuration</span><span class="o">(</span><span class="n">shortAnimTime</span><span class="o">).</span><span class="na">alpha</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setListener</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimatorListenerAdapter</span><span class="o">()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animator</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mLoginFormView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>The ViewPropertyAnimator APIs are not available, so simply show
and hide the relevant UI components.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="n">mLoginStatusView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span><span class="o">);</span>
      <span class="n">mLoginFormView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">show</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Thu May 02 2013 19:53:15 GMT+0000 (UTC)  </div></div></body></html>